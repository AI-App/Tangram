set -e
npm install
cargo build -p tangram_node
install -D ../../target/debug/libtangram_node.so node/dist/x86_64-unknown-linux-gnu/tangram.node
cargo build --target wasm32-unknown-unknown -p tangram_wasm
wasm-bindgen \
  --target bundler \
  --out-dir wasm/dist/bundler \
  ../../target/wasm32-unknown-unknown/debug/tangram_wasm.wasm
wasm-bindgen \
  --target nodejs \
  --out-dir wasm/dist/node \
  ../../target/wasm32-unknown-unknown/debug/tangram_wasm.wasm
mv wasm/dist/node/tangram_wasm.js wasm/dist/node/tangram_wasm.cjs
npx tsc --module commonjs
mv common.js common.cjs
mv common.js.map common.cjs.map
npx tsc
sed -i '1s/^/\/\/\/ <reference types=".\/common.d.ts" \/>\n/' common.js
